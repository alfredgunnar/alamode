var version="0.23",einridePathMap=null,alamode={reportError:function(e){$("<h1 class='mode-error'>").text(e).prependTo(document.body)},getColumnsFromQuery:function(t){var e=datasets.filter(function(e){if(e)return e.queryName==t})[0];return e?e.columns:(alamode.reportError("No such query: '"+t+"'"),[])},getDataFromQuery:function(t){var e=datasets.filter(function(e){if(e)return e.queryName==t})[0];return e?e.content:(alamode.reportError("No such query: '"+t+"'"),[])},makeId:function(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",a="",n=0;n<e;n++)a+=t.charAt(Math.floor(Math.random()*t.length));return a},addContainerElement:function(e,t){return t=t||!1,id=alamode.makeId(10),"body"==e?$("<div id='"+id+"'></div>").addClass(id).addClass("mode-graphic-container").appendTo(".mode-content"):0===$(e).length?alamode.reportError("No such element: '"+e+"'"):(t&&$(e).empty(),$(e).addClass("mode-graphic-container"),$(e).addClass(id)),"."+id},addLinksToTables:function(e){var r="#"+e.table_id,t=e.link_columns,a=e.link_urls,n=e.query_name,d=e.open_in_new_tab||!1,o=[],s={};t.forEach(function(e,t){o.push({column:e,link_string:a[t]})});var c=alamode.getDataFromQuery(n);alamode.getColumnsFromQuery(n);function l(t){var e,a=$(r+" table"),n=$(r+" .js-header-table"),n=n?$(r+" .js-col-header"):$(n).find("th"),a=a.find("tr");n.each(function(){text=$(this).find(".axel-table-header-label").text(),e=$(this).attr("data-axel-column"),s[text]=e-1}),a.each(function(e){var l,i;0<e&&e<=c.length&&(l=$(this).find("td"),i=l.first().attr("data-axel-rowkey"),t.forEach(function(e){var t=s[e.column],a=l.eq(t).text();for(url=e.link_string;-1!=url.indexOf("{{");){var n=url.length,r=url.indexOf("{{"),o=url.substring(r+2,n).indexOf("}}"),n=url.substring(r+2,r+o+2),o=url.substring(r,r+o+4),n=(s[n],c[i][n]);url=url.replace(o,n)}a="<a target='"+(d?"_blank":"_top")+"' href='"+encodeURI(url)+"'>"+a+"</a>";l.eq(t).html(a)}))})}setTimeout(function(){l(o)},1e3),$(r).mousemove(function(){l(o)})},customChartColors:function(e){var t=e.charts,n=e.colors,l=e.opacity,d=e.line_dashes;function m(e,t){var e=$("#"+e),a=(0<e.find(".nv-bar").length?e.find(".nv-group"):0<e.find(".nv-line").length||0<e.find(".nv-areaWrap").length?e.find(".nv-noninteractive"):e.find(".nv-pie .nv-slice")).length,n=e.find(".nv-series .nv-legend-symbol"),r={},o={},l={},d=0;if(0==n.length&&a<=1)o[0]=d,r[l[d]=0]=t[0];else if(0==n.length&&1<a)for(i=0;i<a;i++)o[i]=i,r=t;else for(i=0;i<n.length;i++)r[i]=t[i%Object.keys(t).length];return n.each(function(e){1==$(this).css("fill-opacity")?(o[e]=d,l[d]=e,d+=1):o[e]=-1}),{chart:e,legend:n,colors:r,m:o,r:l,seriesCount:a}}"all"==t&&(t=[],$("mode-chart").each(function(){t.push(this.id)})),setInterval(function(){t.forEach(function(o){!function(e){var t,a=(e=m(o,e)).chart,n=e.colors,r=e.m;for(t in n)a.find(".nv-linesWrap .nv-groups .nv-series-"+r[t]).css({fill:n[t],stroke:n[t]}),a.find(".nv-barsWrap .nv-groups .nv-series-"+r[t]+" rect").css({fill:n[t],stroke:n[t]}),a.find(".nv-linePlusBar .nv-barsWrap .nv-bars rect").each(function(e){$(this).css({fill:n[0],stroke:n[0]})}),a.find(".nv-linePlusBar .nv-linesWrap .nv-groups .nv-series-0").css({fill:n[1],stroke:n[1]}),a.find(".nv-scatterWrap .nv-groups .nv-series-"+r[t]).css({fill:n[t],stroke:n[t]}),a.find(".nv-areaWrap .nv-area-"+r[t]).css({fill:n[t],stroke:n[t]}),a.find(".nv-pie .nv-slice").each(function(e){$(this).css({fill:n[e],stroke:n[e]})});for(t in l)a.find(".nv-linesWrap .nv-groups .nv-series-"+r[t]).css({opacity:l[t]}),a.find(".nv-barsWrap .nv-groups .nv-series-"+r[t]+" rect").css({opacity:l[t]}),0==t&&(a.find(".nv-linePlusBar .nv-barsWrap .nv-bars rect").each(function(e){$(this).css({opacity:l[t]})}),a.find(".nv-linePlusBar .nv-linesWrap .nv-groups .nv-series-0").css({opacity:l[1]})),a.find(".nv-scatterWrap .nv-groups .nv-series-"+r[t]).css({opacity:l[t]}),a.find(".nv-areaWrap .nv-area-"+r[t]).css({opacity:l[t]}),a.find(".nv-pie .nv-slice").each(function(e){$(this).css({opacity:l[e]})});for(t in d)a.find(".nv-linesWrap .nv-groups .nv-series-"+r[t]).css({"stroke-dasharray":d[t]});a.find(".nv-legendWrap .nv-series .nv-legend-symbol").each(function(e){$(this).css({fill:n[e],stroke:n[e]})})}(n)})},500),t.forEach(function(e){var t,a,u;t=e,a=n,u=$("#"+t),$(u).mousemove(function(){var e=m(t,a),n=e.legend,r=e.colors,o=e.r,l=e.m,i=e.seriesCount,d=isArea=u.find(".nv-area").length,s=u.find(".nv-bar").length,c=u.find(".nv-line").length;$("html").find(".nvtooltip table .legend-color-guide").each(function(e){var t,a;0==n.length&&0==s?$(this).find("div").css({"background-color":r[l[e]]}):0<c&&0<s?(t=u.find(".nv-linePlusBar .nv-linesWrap .nv-groups .nv-series-0").css("fill"),a=u.find(".nv-linePlusBar .nv-barsWrap .nv-bars rect").css("fill"),""==$(this).closest(".nvtooltip").find(".key")[0].innerText?$(this).find("div").css("background-color",a):$(this).find("div").css("background-color",t)):0<s?1==i&&$(this).find("div").css({"background-color":r[o[i-e-1]]}):0<d?$(this).find("div").css({"background-color":r[d-e-1]}):$(this).find("div").css({"background-color":r[e]})});e=u.find(".nv-pie .nv-slice.hover").css("fill");$("html").find(".nvtooltip table .legend-color-guide div").css("background-color",e)}),$(u).mouseleave(function(){$("html").find(".nvtooltip table .legend-color-guide").remove()})})},addTotalsRow:function(e){var n,r,t,a=e.query_name,o="#"+(e.table_id||""),l=alamode.getColumnsFromQuery(a),i=alamode.getDataFromQuery(a),a=e.columns_with_totals,d=e.fmt||d3.format(","),a=(t=a,numberColumns=_.map(_.filter(l,function(e){return-1!=["number","integer","float"].indexOf(e.type)}),"name"),"all"==t?numberColumns:_.intersection(t,numberColumns)),s=(n=a,r=[],l.forEach(function(e,t){var a;a=-1==n.indexOf(e.name)?{idx:t,name:"",total:""}:(a=_.map(i,e.name),a=d3.sum(a),{idx:t,name:e.name,total:a}),r.push(a)}),r);setTimeout(function(){container="#"==o?(table=$(".main-table"),$(".js-table-content-container")):(table=$(o+" .main-table"),$(o+" .js-table-content-container"));var t,e=table.find("tr:last"),a=(t="<tr><td>TTL</td>",s.forEach(function(e){""!=e.total?t=t+"<td class='cell-type-number'>"+d(e.total)+"</td>":t+="<td></td>"}),t+"</tr>"),n=+container.css("height").match(/\d+/)[0];e.after(a),container.css("height",26+n)},1e3)},addImagesToTables:function(e){var n="#"+e.table,r=e.column,o=e.image_height||100;function t(){var e=$(n+" table"),t=$(n+" .js-header-table"),t=t?$(n+" .js-col-header"):$(t).find("th"),e=e.find("tr"),a=0;t.each(function(){text=$(this).find(".axel-table-header-label").text(),text==r&&(a=+$(this).attr("data-axel-column"))}),e.each(function(){$(this).find("td").each(function(e){e==a-1&&(e=$(this).text(),0==$(this).find("img").length&&($(this).css("text-align","center"),$(this).html("<img style='height: "+o+"px;' src='"+e+"'>")))})})}setTimeout(function(){t()},1e3),$(n).keyup(function(){setTimeout(function(){t()},500)}),$(n).mousemove(function(){t()})},resizeChartHeight:function(e){var t=e.chart,e=e.height;"python"==t.slice(0,6)?($("#"+t+" .mode-python").css("height",e),$("#"+t+" .mode-python").css("max-height",e),$("#"+t+" img").css("max-height",e)):($("#"+t+" .chart").css("height",e),$("#"+t+" .chart-svg").css("height",e)),window.dispatchEvent(new Event("resize"))},retentionHeatmap:function(e){var a,n,r,t=e.query_name,i=e.cohort_column,d=e.pivot_column,s=e.value_column,o=e.color_gradient||["#d73027","#f46d43","#fdae61","#fee08b","#ffffbf","#d9ef8b","#a6d96a","#66bd63","#1a9850"],l=e.gradient_by||"all",c=e.gradient_column||s,u=e.total_column,m=e.html_element||"body",h=e.title||t,p=e.pivot_label||"",f=e.value_is_percent,g=e.precision||0,v=alamode.getDataFromQuery(t),y=alamode.getColumnsFromQuery(t),t=_.uniq(_.map(v,i)),x=_.sortBy(_.uniq(_.map(v,d))),m=alamode.addContainerElement(m);"cohort_column"===l?(a={},t.forEach(function(t){var e=v.filter(function(e){return e[i]===t});a[t]=d3.scale.quantize().domain(d3.extent(e,function(e){return e[c]})).range(o)})):"pivot_column"===l?(n={},x.forEach(function(t){var e=v.filter(function(e){return e[d]===t});n[t]=d3.scale.quantize().domain(d3.extent(e,function(e){return e[c]})).range(o)})):r=d3.scale.quantize().domain(d3.extent(v,function(e){return e[c]})).range(o),d3.select(m).append("div").attr("class","mode-graphic-title").text(h),d3.select(m).append("div").attr("class","mode-retention-heatmap-label").text(p),headers=(u?[i,u]:[i]).concat(x);m=d3.select(m).append("table").attr("class","mode-retention-heatmap-table");function b(t){return y.filter(function(e){return e.name==t})[0].type}m.selectAll(".mode-retention-heatmap-table-header").data([0]).enter().append("tr").attr("class","mode-retention-heatmap-table-header").selectAll("mode-retention-heatmap-table-header-cell").data(headers).enter().append("td").attr("class",function(e){return isNaN(e)?"mode-retention-heatmap-table-header-cell heatmap-string":"mode-retention-heatmap-table-header-cell heatmap-number"}).text(function(e){return e}),m.selectAll(".mode-retention-heatmap-table-row").data(t).enter().append("tr").attr("class","mode-retention-heatmap-table-row").selectAll(".mode-retention-heatmap-table-cell").data(function(e){return function(r,o){var l=[{column:i,value:o}];{var e;u&&(e=_.filter(r,function(e){return e[i]==o})[0],e={column:u,value:e[u]},l=l.concat(e))}return x.forEach(function(t){var e="",a="",n=_.filter(r,function(e){return e[i]==o&&e[d]==t});0<n.length&&(e=d3.mean(_.map(n,s)),a=d3.mean(_.map(n,c))),l=l.concat({column:s,value:e,cohort:o,pivot:t,gradientValue:a})}),l}(v,e)}).enter().append("td").style("background",function(e){if((t=e).column==s&&""!==t.value)return function(e){{if("cohort_column"===l)return a[e.cohort](e.gradientValue);if("pivot_column"===l)return n[e.pivot](e.gradientValue)}return r(e.gradientValue)}(e);var t}).attr("class",function(e){e=b(e.column);return"float"==e||"integer"==e||"number"==e?"heatmap-number":"heatmap-string"}).text(function(e){return a=b((t=e).column),n=d3.format(","),r=d3.format("."+g+"%"),e=d3.time.format("%b %d, %Y"),""==t.value?t.value:"datetime"==a||"timestamp"==a||"date"==a?"function"==typeof moment?moment(t.value).utc().format("ll"):e(new Date(t.value)):t.column==u?n(t.value):t.column==s&&f?r(t.value):t.column==s?n(t.value):t.value;var t,a,n,r})},simpleHeatmap:function(e){var t=e.query_name,o=e.x_column,l=e.y_column,i=e.value_column,a=e.max_value||Number.MAX_VALUE,d=0===e.min_value?0:e.min_value||Number.MIN_VALUE,n=e.color_gradient||["#d73027","#f46d43","#fdae61","#fee08b","#ffffbf","#d9ef8b","#a6d96a","#66bd63","#1a9850"],r=e.html_element||"body",s=e.title||t,c=(e.x_label,e.y_label||""),u=e.value_is_percent,m=e.precision||0,h=alamode.getDataFromQuery(t),p=alamode.getColumnsFromQuery(t),t=_.uniq(_.map(h,o)),f=_.uniq(_.map(h,l)),r=alamode.addContainerElement(r),g=d3.scale.quantize().domain(d3.extent(h,function(e){return Math.max(d,Math.min(a,e[i]))})).range(n);d3.select(r).append("div").attr("class","mode-graphic-title").text(s),d3.select(r).append("div").attr("class","mode-simple-heatmap-label").text(c),headers=[o].concat(f);r=d3.select(r).append("table").attr("class","mode-simple-heatmap-table");function v(t){return p.filter(function(e){return e.name==t})[0].type}r.selectAll(".mode-simple-heatmap-table-header").data([0]).enter().append("tr").attr("class","mode-simple-heatmap-table-header").selectAll("mode-simple-heatmap-table-header-cell").data(headers).enter().append("td").attr("class",function(e){return isNaN(e)?"mode-simple-heatmap-table-header-cell heatmap-string":"mode-simple-heatmap-table-header-cell heatmap-number"}).text(function(e){return e}),r.selectAll(".mode-simple-heatmap-table-row").data(t).enter().append("tr").attr("class","mode-simple-heatmap-table-row").selectAll(".mode-simple-heatmap-table-cell").data(function(e){return a=h,r=[{column:o,value:n=e}],f.forEach(function(t){var e=_.filter(a,function(e){return e[o]==n&&e[l]==t});entry=0<e.length?d3.mean(_.map(e,i)):d,r=r.concat({column:i,value:entry})}),r;var a,n,r}).enter().append("td").style("background",function(e){if(""!==(t=e).value&&(t.column!=o&&t.column==i))return g(Math.max(d,Math.min(a,e.value)));var t}).attr("class",function(e){e=v(e.column);return"float"==e||"integer"==e||"number"==e?"heatmap-number":"heatmap-string"}).text(function(e){return a=v((t=e).column),n=d3.format(","),r=d3.format("."+m+"%"),e=d3.time.format("%b %d, %Y"),""==t.value?t.value:"datetime"==a||"timestamp"==a||"date"==a?"function"==typeof moment?moment(t.value).utc().format("ll"):e(new Date(t.value)):t.column==i&&u?r(t.value):t.column==i?n(t.value):t.value;var t,a,n,r})},googleMap:function(e){var t=alamode.makeId(10),l=e.lat_column,i=e.lng_column,a=e.query_name,n=e.google_maps_api_key,r=e.title||a,d=e.label_column,o=e.html_element||"body",s=e.center_lat||39.5,c=e.center_lng||-98.35,u=e.starting_zoom||4,m=e.map_type||"terrain",e=e.height||600,h=alamode.getDataFromQuery(a),o=alamode.addContainerElement(o);d3.select(o).append("div").attr("class","mode-graphic-title").text(r),d3.select(o).append("div").attr("class","mode-google-map").attr("id",t).style("height",e+"px"),jQuery.getScript("https://maps.googleapis.com/maps/api/js?key="+n,function(){var e,o;e={zoom:u,center:new google.maps.LatLng(s,c),mapTypeId:m},o=new google.maps.Map(document.getElementById(t),e),h.forEach(function(e){var t=e[l],a=e[i];label=d?e[d]:"";var n=new google.maps.Marker({position:{lat:t,lng:a},map:o,title:label}),r=new google.maps.InfoWindow({content:label});n.addListener("click",function(){r.open(o,n)})})})},pathMap:function(e){var t=alamode.makeId(10),a=e.start_lat_column,n=e.start_lng_column,r=e.end_lat_column,o=e.end_lng_column,l=e.center_lat||0,i=e.center_lng||0,d=e.starting_zoom||4,s=e.query_name,c=e.html_element||"body",u=e.apply_filter||!1,m=e.style_fn,h=e.popup_content_fn,e=(e.mapbox_access_token,e.height||400),s=alamode.getDataFromQuery(s),p=[];null===einridePathMap&&(einridePathMap={},c=alamode.addContainerElement(c,u),u=$(c).width(),d3.select(c).append("div").attr("class","mode-mapbox-map").attr("id",t).style("height",e+"px").style("width",u+"px"),einridePathMap.baseLayer=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18}),einridePathMap.onEachFeature=()=>{},einridePathMap.geoJsonLayer=L.geoJSON({type:"Feature",geometry:{type:"Point",coordinates:[0,0]}},{onEachFeature:(e,t)=>einridePathMap.onEachFeature(e,t)}),d={lat:l,lng:i,zoom:d},einridePathMap.map=new L.Map(t,{center:new L.LatLng(d.lat,d.lng),zoom:Math.floor(d.zoom),layers:[einridePathMap.baseLayer,einridePathMap.geoJsonLayer]})),s.forEach(function(e){"number"==typeof e[a]&&"number"==typeof e[n]&&"number"==typeof e[r]&&"number"==typeof e[o]&&p.push(e)}),features=s.map(e=>({type:"Feature",properties:e,geometry:{type:"LineString",coordinates:[[e[n],e[a]],[e[o],e[r]]]}})),einridePathMap.geoJsonLayer.clearLayers(),einridePathMap.onEachFeature=(e,t)=>{e.properties&&h&&t.bindPopup(h(e.properties))},einridePathMap.geoJsonLayer.addData(features),void 0!==m&&einridePathMap.geoJsonLayer.setStyle(e=>m(e.properties))},leafletMap:function(e){var t=alamode.makeId(10),a=e.lat_column,n=e.lng_column,r=e.query_name,o=e.title||r,l=e.height||400,i=e.html_element||"body",d=e.center_lat||39.5,s=e.center_lng||-98.35,c=e.starting_zoom||4,u=e.dot_size||.4,m=e.dot_opacity||.8,e=e.apply_filter||!1,r=alamode.getDataFromQuery(r),h=[];r.forEach(function(e){"number"==typeof e[a]&&"number"==typeof e[n]&&h.push(e)});e=alamode.addContainerElement(i,e);d3.select(e).style("height",l+"px").append("div").attr("class","mode-graphic-title").text(o);o=l-$(e+".mode-graphic-title").height(),l=$(e).width();d3.select(e).append("div").attr("class","mode-leaflet-map").attr("id",t).style("height",o+"px").style("width",l+"px");o=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18}),l={max:8,data:h},c={lat:d,lng:s,zoom:c},m=new HeatmapOverlay({radius:u,maxOpacity:m,scaleRadius:!0,useLocalExtrema:!0,latField:a,lngField:n}),new L.Map(t,{center:new L.LatLng(c.lat,c.lng),zoom:Math.floor(c.zoom),layers:[o,m]});m.setData(l)},wordCloud:function(e){var t=e.query_name,a=e.word_column,n=e.word_count_column,r=e.html_element||"body",o=e.title||t,l=e.height||"400",i=e.width||"800",d=e.colors||["black"],t=alamode.getDataFromQuery(t),s=alamode.addContainerElement(r);d3.select(s).append("div").attr("class","mode-graphic-title").text(o);var c=d3.scale.linear().domain(d3.extent(t,function(e){return e[n]})).range([12,60]),u=d3.layout.cloud().size([i,l]).words(t.map(function(e){return{text:e[a],size:c(e[n])}})).padding(2).rotate(function(){return 360*(~~(6*Math.random())-3)}).font("Impact").fontSize(function(e){return e.size}).on("end",function(e){d3.select(s).append("div").attr("class","mode-wordcloud").append("svg").attr("width",u.size()[0]).attr("height",u.size()[1]).append("g").attr("transform","translate("+u.size()[0]/2+","+u.size()[1]/2+")").selectAll("text").data(e).enter().append("text").style("font-size",function(e){return e.size+"px"}).style("font-family","Impact").style("fill",function(e,t){return d[t%d.length]}).attr("text-anchor","middle").attr("transform",function(e){return"translate("+[e.x,e.y]+")rotate("+e.rotate+")"}).text(function(e){return e.text})});u.start()},funnel:function(e){var t=alamode.makeId(10),a=e.query_name,n=e.stage_column,r=e.value_column,o=e.html_element||"body",l=e.title||a,i=e.height||"300",e=e.width||"500",a=alamode.getDataFromQuery(a),o=alamode.addContainerElement(o);d3.select(o).append("div").attr("class","mode-graphic-title").text(l),d3.select(o).append("div").attr("class","mode-funnel").attr("id",t).style("width",e+"px").style("height",i-20+"px");var d=[];a.forEach(function(e){d.push([e[n],e[r]])});new D3Funnel("#"+t).draw(d,{label:{format:"{l}: {f}"},block:{dynamicHeight:!0},chart:{bottomPinch:1},animation:100}),d3.select("#"+t).style("height",i+"px")},horizontalBarChart:function(n){var e=n.query_name,t=(n.bar_column,n.series_columns),r=n.colors||["#EE8D24","#43A5DA","#6AB328","#BB60F8","#E14459","#EAD022","#06D0AD","#DB38B7"];stacked=n.stacked||!1,leftpad=n.left_pad||175,htmlElement=n.html_element||"body",title=n.title||e,height=n.chart_height||395,width=n.width||"500";var o=alamode.getDataFromQuery(e),a=alamode.addContainerElement(htmlElement);d3.select(a).append("div").attr("class","mode-graphic-title").text(title),d3.select(a).append("div").attr("class","mode-horizontal-bar-chart").style("height",height-50+"px").append("svg");var l=[];t.forEach(function(t,e){var e={key:t,color:r[e%r.length]},a=[];o.forEach(function(e){a.push({label:e[n.bar_column],value:e[t]})}),e.values=a,l.push(e)}),nv.addGraph(function(){var e=nv.models.multiBarHorizontalChart().x(function(e){return e.label}).y(function(e){return e.value}).margin({top:30,right:20,bottom:50,left:leftpad}).showValues(!0).showControls(!1).stacked(stacked);return e.yAxis.tickFormat(d3.format(",.2f")),d3.select(a+" svg").datum(l).call(e),nv.utils.windowResize(e.update),e})},chartAnnotations:function(e){var u="#"+e.chart_id,n=e.x_axis_column,t=e.query_name,m=e.orientations,h=e.comment_values,r=e.group_by,a=e.comments,o=alamode.getDataFromQuery(t),p=[],l={};function i(){a.forEach(function(e,t){var a,n,r=p[t],o=m[t],l=h[t],i=d3.tip().attr("class","d3-tip").style("z-index",100).offset([-10,0]).html(function(e){return e}),d=$(u).find("g.nvd3.nv-wrap").attr("transform"),s=d.indexOf("("),c=d.indexOf(")"),t=d.indexOf(","),s=+d.slice(s+1,t),t=+d.slice(t+1,c);-1!=r&&"v"==o?(a=(c=$(u).find(".nv-point.nv-point-"+r).attr("transform")).indexOf("("),n=c.indexOf(")"),r=c.indexOf(","),a=+c.slice(a+1,r),r=+c.slice(r+1,n),$(u).find("g.nvd3.nv-wrap").first().find("rect").first().attr("height"),$(u).find("g.nvd3.nv-wrap").first().find("rect").first().attr("width"),(n=d3.select(u+" .nvd3svg")).call(i),n.append("rect").attr("x",a+s).attr("y",t-5).attr("width",1).attr("class","flag").attr("height",5+r).attr("fill","#ff8f53"),n.append("circle").data([e]).attr("cx",a+s).attr("cy",t-5).attr("class","flag").attr("r",5).attr("fill","#ff8f53").on("mouseover",i.show).on("mouseout",i.hide)):"h"!=o&&"h-left"!=o&&"h-right"!=o||(y="h"==o?"":"1",$(u).find("g.nv-y"+y+".nv-axis").find(".tick").each(function(e){lineLength="h-right"==o?+$(u).find("g.nv-y1.nv-axis").find(".tick").first().find("line").attr("x2"):+$(this).find("line").attr("x2"),tickTrans=$(this).attr("transform"),tickClosePos=tickTrans.indexOf(")"),tickCommaPos=tickTrans.indexOf(","),0==e?(yTrans1=+tickTrans.slice(tickCommaPos+1,tickClosePos),yVal1=+$(this).find("text").text().replace(",","")):1==e&&(yTrans2=+tickTrans.slice(tickCommaPos+1,tickClosePos),yVal2=+$(this).find("text").text().replace(",",""))}),a=(yTrans2-yTrans1)/(yVal2-yVal1),a=yTrans2-yVal2*a+l*a,(n=d3.select(u+" .nvd3svg")).call(i),n.append("rect").attr("x",s).attr("y",a+t).attr("width",lineLength+10).attr("height",1).attr("class","flag").attr("fill","#ff8f53"),n.append("circle").data([e]).attr("cx",lineLength+s+10).attr("cy",a+t).attr("class","flag").attr("r",5).attr("fill","#ff8f53").on("mouseover",i.show).on("mouseout",i.hide))})}r&&(l=_.groupBy(o,function(e){return e[r]})),a.forEach(function(e,t){var a=_.filter(o,function(e){return e[n]==h[t]});pointNumber=0!=a.length?(r?l[a[0][r]]:o).indexOf(a[0]):-1,p.push(pointNumber)}),setTimeout(function(){d3.select(u).selectAll(".flag").remove(),i()},1e3),$(window).resize(function(){d3.select(u).selectAll(".flag").remove(),s(function(){i()},500,"")});var d,s=(d={},function(e,t,a){d[a=a||"Don't call this twice without a uniqueId"]&&clearTimeout(d[a]),d[a]=setTimeout(e,t)})},bulletChart:function(l){var i=alamode.makeId(10),e=l.query_name,t=l.html_element||"body",a=l.title||e,d=l.chart_width||"800",s=l.bar_column||"",c=l.marker_column||"",u=l.left_pad||150,m=l.color,e=alamode.getDataFromQuery(e),t=alamode.addContainerElement(t);d3.select(t).append("div").attr("class","mode-graphic-title").text(a),d3.select(t).append("div").attr("class","mode-bullet-chart").style("width",d).attr("id",i),e.forEach(function(e){var t=e[l.title_column]||"",a=e[l.subtitle_column]||"",n=e[l.marker_column]||"",r=e[l.bar_column]||"";scale=l.scale_columns&&[e[l.scale_columns[0]],e[l.scale_columns[1]],e[l.scale_columns[2]]];var o={title:t,subtitle:a,ranges:scale,measures:[r],measureLabels:[s],markers:[n],markerLabels:[c],color:m};nv.addGraph(function(){var e=nv.models.bulletChart().height(50).width(d).margin({left:u,right:15,top:10,bottom:10});d3.select("#"+i).append("svg").style("width",d+"px").style("height","70px").style("display","inline").datum(o).transition().duration(500).call(e);return e})})},sunburstChart:function(e){var o=alamode.makeId(10),t=e.query_name,n=e.event_columns,r=e.event_counts,a=e.title||t,l=e.color_range||["#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00","#ffff33","#a65628","#f781bf","#999999"],e=e.html_element||"body",d=alamode.getDataFromQuery(t),s=850,c=Math.min(s,600)/2,u={w:(s-30)/n.length,h:20,s:3,t:10},m=[];n.forEach(function(e){m=m.concat(_.uniq(_.map(d,e)))});var t=_.uniq(m),h={};t.forEach(function(e,t){null!=e&&(h[e]=l[t%l.length])}),h.end="#666";var p=0,e=alamode.addContainerElement(e);d3.select(e).append("div").attr("class","mode-graphic-title").text(a),d3.select(e).append("div").attr("class","mode-sunburst-sequence").attr("id","sequence-"+o),d3.select(e).append("div").attr("class","mode-sunburst").attr("id",o),d3.select(e).append("div").attr("class","mode-sunburst-legend-container").attr("id","legend-container-"+o),vis=d3.select("#"+o).append("svg:svg").attr("width",s).attr("height",600).append("svg:g").attr("transform","translate("+s/2+",300)"),vis.append("text").attr("x",0).attr("y",-30).attr("text-anchor","middle").attr("class","mode-sunburst-explanation mode-sunburst-percentage").attr("id","percentage-"+o).style("visibility","hidden").text(""),vis.append("text").attr("x",0).attr("y",-10).attr("text-anchor","middle").attr("class","mode-sunburst-explanation").style("visibility","hidden").text("of total sequences."),vis.append("text").attr("x",0).attr("y",20).attr("text-anchor","middle").attr("class","mode-sunburst-explanation mode-sunburst-cond-percentage").attr("id","cond-percentage-"+o).style("visibility","hidden").text(""),vis.append("text").attr("x",0).attr("y",40).attr("text-anchor","middle").attr("class","mode-sunburst-explanation").style("visibility","hidden").text("from previous location.");var f=d3.layout.partition().size([2*Math.PI,c*c]).value(function(e){return e.size}),g=d3.svg.arc().startAngle(function(e){return e.x}).endAngle(function(e){return e.x+e.dx}).innerRadius(function(e){return Math.sqrt(e.y)}).outerRadius(function(e){return Math.sqrt(e.y+e.dy)}),v=[];function y(e){var t=(100*e.value/p).toPrecision(3),a=t+"%";t<.1&&(a="< 0.1%");var n=b(e),r=e.parent.value,t=(100*e.value/r).toPrecision(3),r=t+"%";t<1&&(a="< 1%"),d3.select("#cond-percentage-"+o).text(r),d3.select("#percentage-"+o).text(a),d3.selectAll(".mode-sunburst-explanation").style("visibility","");n=b(e);a=n,e=d3.select("#trail-"+o).selectAll("g").data(a,function(e){return e.name+e.depth}),(a=e.enter().append("svg:g")).append("svg:polygon").attr("points",w).style("fill",function(e){return h[e.name]}),a.append("svg:text").attr("x",(u.w+u.t)/2).attr("y",u.h/2).attr("dy","0.35em").attr("text-anchor","middle").text(function(e){return e.name}),e.attr("transform",function(e,t){return 5<t&&t<10?"translate("+(t-=5)*(u.w+u.s)+", 20)":10<t?"translate("+(t-=11)*(u.w+u.s)+", 40)":"translate("+t*(u.w+u.s)+", 0)"}),e.exit().remove(),d3.select("#trail-"+o).style("visibility",""),d3.selectAll("path").style("opacity",.3),vis.selectAll("path").filter(function(e){return 0<=n.indexOf(e)}).style("opacity",1)}function x(e){d3.select("#trail-"+o).style("visibility","hidden"),d3.selectAll("path").on("mouseover",null),4==d3.version.split(".")[0]?d3.selectAll("path").transition().duration(300).style("opacity",1).on("end",function(){d3.select(this).on("mouseover",y)}):d3.selectAll("path").transition().duration(300).style("opacity",1).each("end",function(){d3.select(this).on("mouseover",y)}),d3.selectAll(".mode-sunburst-explanation").style("visibility","hidden")}function b(e){for(var t=[],a=e;a.parent;)t.unshift(a),a=a.parent;return t}function w(e,t){var a=[];return a.push("0,0"),a.push(u.w+",0"),a.push(u.w+u.t+","+u.h/2),a.push(u.w+","+u.h),a.push("0,"+u.h),0<t&&a.push(u.t+","+u.h/2),a.join(" ")}d.forEach(function(e){var t="";for(i=0;i<n.length;i++){if(prefix=0!=i?"-~-":"",null==e[n[i]]){t=t+prefix+"end";break}t=t+prefix+e[n[i]]}var a={0:t,1:e[r]};v.push(a)}),function(e){d3.select("#sequence-"+o).append("svg:svg").attr("width",s).attr("height",60).attr("id","trail-"+o).append("svg:text").attr("id","endlabel").style("fill","#000"),function(){var t=195,a=30,n=3;d3.entries(h).forEach(function(e){divContainer=d3.select("#legend-container-"+o).append("div").attr("class","mode-sunburst-legend").attr("id","legend-"+o),svg=divContainer.append("svg:svg").attr("width",t).attr("height",a),svg.append("svg:rect").attr("rx",n).attr("ry",n).attr("width",t).attr("height",a).style("fill",function(){return e.value}),svg.append("svg:text").attr("x",t/2).attr("y",a/2).attr("dy","0.35em").attr("text-anchor","middle").text(function(){return e.key})})}(),vis.append("svg:circle").attr("r",c).style("opacity",0);var t=f.nodes(e).filter(function(e){return.005<e.dx}),t=vis.data([e]).selectAll("path").data(t).enter().append("svg:path").attr("display",function(e){return e.depth?null:"none"}).attr("d",g).attr("fill-rule","evenodd").style("fill",function(e){return h[e.name]}).style("opacity",1).on("mouseover",y);vis.on("mouseleave",x),p=t.node().__data__.value}(function(e){for(var t,a={name:"root",children:[]},n=0;n<e.length;n++){var r=e[n][0],o=+e[n][1];if(!isNaN(o))for(var l=r.split("-~-"),i=a,d=0;d<l.length;d++){var s=i.children,c=l[d];if(d+1<l.length){for(var u=!1,m=0;m<s.length;m++)if(s[m].name==c){t=s[m],u=!0;break}u||(t={name:c,children:[]},s.push(t)),i=t}else t={name:c,size:o},s.push(t)}}return a}(v))},zipcodeChoropleth:function(e){var a=alamode.makeId(10),t=e.query_name,n=e.zipcode_column,r=e.value_column,o=e.width||950,l=e.height||o/1.9,i=e.title||t,d=e.color_range,s=e.color_gradient||["#FFF8CC","#FFF5B2","#FFF299","#E5D87F","#CCBF66","#B2A54C","#998C33","#7F7219","#665900"],c=e.html_element||"body",e=alamode.getDataFromQuery(t),u=d3.map(),t=d3.geoAlbersUsa().scale(o).translate([o/2,l/2]),m=d3.geoPath().projection(t),c=alamode.addContainerElement(c);d3.select(c).append("div").attr("class","mode-graphic-title").text(i),svg=d3.select(c).append("div").attr("class","mode-zipcode-chorolpleth").append("svg").attr("id","mode-zipcode-chorolpleth-"+a).attr("width",o).attr("height",l),e.forEach(function(e){u.set(e[n],+e[r])}),colorDomain=d||d3.extent(e,function(e){return e[r]});var h=d3.scale.quantize().domain(colorDomain).range(s);queue().defer(d3.json,"https://s3-us-west-2.amazonaws.com/mode-alamode/zips_us_topo.json").await(function(e,t){d3.select("#mode-zipcode-chorolpleth-"+a).append("g").attr("class","zipcodes").selectAll(".mode-zipcode-chorolpleth-zipcodes"+a).data(topojson.feature(t,t.objects.zip_codes_for_the_usa).features).enter().append("path").attr("class","mode-zipcode-chorolpleth-zipcodes-"+a).attr("fill",function(e){return h(u.get(e.properties.zip))}).attr("d",m)})},countyChoropleth:function(e){var a=alamode.makeId(10),t=e.query_name,n=e.county_id_column,r=e.value_column,o=e.width||950,l=e.height||o/1.9,i=e.title||t,d=e.color_range,s=e.color_gradient||["#f7fbff","#deebf7","#c6dbef","#9ecae1","#6baed6","#4292c6","#2171b5","#08519c","#08306b"],c=e.html_element||"body",e=alamode.getDataFromQuery(t),u=d3.map(),t=d3.geoAlbersUsa().scale(o).translate([o/2,l/2]),m=d3.geoPath().projection(t),c=alamode.addContainerElement(c);d3.select(c).append("div").attr("class","mode-graphic-title").text(i),svg=d3.select(c).append("div").attr("class","mode-county-chorolpleth").append("svg").attr("id","mode-county-chorolpleth-"+a).attr("width",o).attr("height",l),e.forEach(function(e){u.set(e[n],+e[r])}),colorDomain=d||d3.extent(e,function(e){return e[r]});var h=d3.scale.quantize().domain(colorDomain).range(s);queue().defer(d3.json,"https://s3-us-west-2.amazonaws.com/mode-alamode/counties.json").await(function(e,t){d3.select("#mode-county-chorolpleth-"+a).append("g").attr("class","mode-county-chorolpleth-counties").selectAll(".mode-county-chorolpleth-counties"+a).data(topojson.feature(t,t.objects.counties).features).enter().append("path").attr("class","mode-county-chorolpleth-counties-"+a).attr("fill",function(e){return h(u.get(e.id))}).attr("d",m),d3.select("#mode-county-chorolpleth-"+a).append("path").datum(topojson.mesh(t,t.objects.states,function(e,t){return e!==t})).attr("class","mode-county-chorolpleth-states").attr("d",m)})},stateChoropleth:function(e){var a=alamode.makeId(10),t=e.query_name,n=e.state_column,r=e.value_column,o=e.state_code_type,l=e.width||950,i=e.height||l/1.9,d=e.title||t,s=e.color_range,c=e.color_gradient||["#f7fbff","#deebf7","#c6dbef","#9ecae1","#6baed6","#4292c6","#2171b5","#08519c","#08306b"],u=e.html_element||"body",e=alamode.getDataFromQuery(t),m=d3.map(),t=d3.geoAlbersUsa().scale(l).translate([l/2,i/2]),h=d3.geoPath().projection(t),u=alamode.addContainerElement(u);d3.select(u).append("div").attr("class","mode-graphic-title").text(d),svg=d3.select(u).append("div").attr("class","mode-state-chorolpleth").append("svg").attr("id","mode-state-chorolpleth-"+a).attr("width",l).attr("height",i),e.forEach(function(e){m.set(e[n],+e[r])}),colorDomain=s||d3.extent(e,function(e){return e[r]});var p=d3.scale.quantize().domain(colorDomain).range(c);queue().defer(d3.json,"https://s3-us-west-2.amazonaws.com/mode-alamode/states.json").await(function(e,t){d3.select("#mode-state-chorolpleth-"+a).append("g").attr("class","mode-state-chorolpleth-states").selectAll(".mode-state-chorolpleth-states-"+a).data(t.features).enter().append("path").attr("class","mode-state-chorolpleth-states-"+a).attr("fill",function(e){return p(m.get(e.properties[o]))}).attr("d",h)})},worldChoropleth:function(e){var a=alamode.makeId(10),t=e.query_name,n=e.country_column,r=e.value_column,o=e.country_code_type,l=e.width||950,i=e.height||.8*l,d=e.title||t,s=e.color_range,c=e.color_gradient||["#9ecae1","#6baed6","#4292c6","#2171b5","#08519c","#08306b"],u=e.html_element||"body",e=alamode.getDataFromQuery(t),m=d3.map(),t=d3.geo.mercator().scale((l+1)/2/Math.PI).translate([l/2,i/2+.1*i]).precision(.1),h=d3.geoPath().projection(t),u=alamode.addContainerElement(u);d3.select(u).append("div").attr("class","mode-graphic-title").text(d),d3.select(u).append("div").attr("class","mode-world-chorolpleth-legend").attr("id","mode-world-chorolpleth-legend-"+a).text("Hover over a country to see details"),svg=d3.select(u).append("div").attr("class","mode-world-chorolpleth").append("svg").attr("id","mode-world-chorolpleth-"+a).attr("width",l).attr("height",i),e.forEach(function(e){m.set(e[n],+e[r])}),s?colorDomain=s:(colorDomain=d3.extent(e,function(e){return e[r]}),e.length<=1&&colorDomain.unshift(0));var p=d3.scale.quantize().domain(colorDomain).range(c);queue().defer(d3.json,"https://s3-us-west-2.amazonaws.com/mode-alamode/world.json").await(function(e,t){d3.select("#mode-world-chorolpleth-"+a).append("g").attr("class","mode-world-chorolpleth-countries-base").selectAll(".mode-world-chorolpleth-countries").data(topojson.feature(t,t.objects.countries).features).enter().append("path").attr("class","mode-world-chorolpleth-countries").attr("fill",function(e){return p(m.get(e.properties[o]))}).attr("d",h).on("mouseover",function(e){var t=e.properties.name;value=m.get(e.properties[o])?m.get(e.properties[o]):"--",d3.select("#mode-world-chorolpleth-legend-"+a).text(t+": "+value)}).on("mouseout",function(e){d3.select("#mode-world-chorolpleth-legend-"+a).text("Hover over a country to see details")}),d3.select("#mode-world-chorolpleth-"+a).append("path").datum(topojson.mesh(t,t.objects.countries,function(e,t){return e!==t})).attr("class","mode-world-chorolpleth-boundaries").attr("d",h)})},pivotTable:function(e){var t=alamode.makeId(10),a=e.query_name,n=e.default_columns,r=e.default_rows,o=e.default_values,l=e.editable,i=e.aggregate_function||"Count",d=e.pivot_table_type||"Table",s=e.title||a,c=e.html_element||"body",u=e.default_exclusions||[],m=e.default_inclusions||[];Array.isArray(o)||(o=[o]);var e=alamode.getDataFromQuery(a),a=alamode.getColumnsFromQuery(a),h=_.map(a,"name"),c=alamode.addContainerElement(c);d3.select(c).append("div").attr("class","mode-graphic-title").text(s),d3.select(c).append("div").attr("class","mode-pivot-table").attr("id",t);var p=[];p.push(h),e.forEach(function(t){var a=[];h.forEach(function(e){a.push(t[e])}),p.push(a)}),l?$("#"+t).pivotUI(p,{cols:n,rows:r,aggregatorName:i,vals:o,rendererName:d,exclusions:u,inclusions:m}):(d=(l=$.pivotUtilities).renderers[d],i=l.aggregators[i],$("#"+t).pivot(p,{cols:n,rows:r,aggregator:i(o),renderer:d,exclusions:u,inclusions:m}))},pieChartLabels:function(e){var t=e.show_all_labels,e=e.chart_id,a=$("#"+e),o={};setInterval(function(){var e,r;r=t,(e=a).find(".nv-legendWrap .nv-series text").each(function(a){var n=$(this).text();e.find(".nv-pieWrap .nv-pieLabels text").each(function(e){var t=a+"-"+e;text=$(this).text(),a==e&&""!=text&&text!=o[t]?text=n+" - "+text:a==e&&r&&text!=o[t]&&(text=n),o[t]=text,$(this).text(text)})})},300)},bigNumberSparkline:function(e){var t="#"+e.chart_id,a=e.x_axis_column,n=e.value_column,r=e.query_name,o=alamode.makeId(12),l=alamode.getDataFromQuery(r),e=alamode.getColumnsFromQuery(r);xType=a?(xMatch=_.filter(e,{name:a}),xMatch[0].type):"string";var i=[];l.forEach(function(e){formattedX="datetime"==xType||"timestamp"==xType||"date"==xType?d3.time.format.utc("%Y-%m-%d")(new Date(Date.parse(e[a]))):e[a];e={x:formattedX,y:e[n]};i.push(e)});r=$(t+" .chart-wrapper"),e=$(t+" .chart-big-number"),l=r.height(),r=r.width(),e=e.height(),l=l-e-20;d3.select(t+" .chart-big-number").append("svg").attr("height",l).attr("width",r).attr("id",o).append("g").attr("transform","translate(0,"+e+")"),nv.addGraph(function(){var e=nv.models.sparklinePlus().margin({left:15,right:15}).x(function(e,t){return t}).xTickFormat(function(e){return i[e].x}).showLastValue(!1);return d3.select("#"+o).datum(i).call(e),e}),setTimeout(function(){d3.selectAll(t+" path").style("stroke-width","2px").style("stroke-linejoin","round").style("stroke","#646C6C"),d3.selectAll(t+" .nv-minValue").style("fill","#EE7437").style("stroke","#EE7437").attr("r",3),d3.selectAll(t+" .nv-maxValue").style("fill","#37B067").style("stroke","#37B067").attr("r",3),d3.selectAll(t+" .nv-currentValue").style("fill","#22A3C0").style("stroke","#22A3C0").attr("r",3)},1e3)},addLinkToBigNumber:function(e){window.ALAMODE_CHARTS=window.ALAMODE_CHARTS||{};var t=e.chart_id.split("_")[1];window.ALAMODE_CHARTS[t]=e.url},forceDirectedGraph:function(e){var t=alamode.makeId(10),a=e.node_query,n=e.edge_query,r=e.html_element||"body",o=e.title||queryName,l=e.chart_width||"800",i=e.chart_height||"800",d=e.group_colors||"",e=e.links_to_show||100,s=alamode.getDataFromQuery(a),n=alamode.getDataFromQuery(n),c=[];n.forEach(function(t){var e=c.filter(function(e){return e.target==t.source}).filter(function(e){return e.source==t.target});0!=e.length?e.edge_size+=t.edge_size:c.push(t)}),c=(c=c.sort(function(e,t){return t.edge_size-e.edge_size})).slice(0,e),nameMap={},s.forEach(function(e,t){e.id=t,nameMap[e.node]=t}),c.forEach(function(e){e.source_id=nameMap[e.source],e.target_id=nameMap[e.target]});r=alamode.addContainerElement(r);d3.select(r).append("div").attr("class","mode-graphic-title").text(o),d3.select(r).append("div").attr("class","mode-force-directed-graph").style("width",l).attr("id",t);o=d3.tip().attr("class","mode-force-directed-graph-tooltip").offset([-10,0]).html(function(e){return e.node}),r=d3.layout.force().linkDistance(40).linkStrength(1).size([l,i]),l=d3.select("#"+t).append("svg").attr("width",l).attr("height",i);l.call(o);var i={nodes:s,links:c},u=d3.scale.linear().domain(d3.extent(s,function(e){return e.node_size})).range([2,20]),m=d3.scale.linear().domain(d3.extent(c,function(e){return e.edge_size})).range([1,10]),h=d3.scale.linear().domain(d3.extent(c,function(e){return e.edge_size})).range([.1,.9]),s=i.nodes.slice(),c=[],p=[];i.links.forEach(function(e){var t=s[e.source_id],a=s[e.target_id],n={};n.connections=e.edge_size,s.push(n),c.push({source:t,target:n},{source:n,target:a}),p.push([t,n,a])}),r.nodes(s).links(c).start();var f=l.selectAll(".mode-force-directed-graph-link ").data(p).enter().append("path").attr("class","mode-force-directed-graph-link").style("stroke-width",function(e){return m(e[1].connections)}).style("opacity",function(e){return h(e[1].connections)}),g=l.selectAll(".mode-force-directed-graph-node").data(i.nodes).enter().append("g").attr("class","mode-force-directed-graph-node").call(r.drag);g.append("circle").attr("r",function(e){return u(e.node_size)}).style("fill",function(e){return d?d[e.node_group]:"#0E819A"}).on("mouseover",o.show).on("mouseout",o.hide),r.on("tick",function(){f.attr("d",function(e){return"M"+e[0].x+","+e[0].y+"S"+e[1].x+","+e[1].y+" "+e[2].x+","+e[2].y}),g.attr("transform",function(e){return"translate("+e.x+","+e.y+")"})})},networkMatrix:function(e){var t=alamode.makeId(10),a=e.node_query,n=e.edge_query,r=e.html_element||"body",o=e.title||queryName,l=e.padding_for_names||"200",i=e.chart_width||"800",d=e.chart_height||"800",s=e.group_colors||"",c=e.left_label||"",u=e.top_label||"",m=l,h=10,e=10,l=l,p=alamode.getDataFromQuery(a),n=alamode.getDataFromQuery(n);nameMap={},p.forEach(function(e,t){e.id=t,nameMap[e.node]=t}),n.forEach(function(e){e.source_id=nameMap[e.source],e.target_id=nameMap[e.target]});var f=d3.scale.ordinal().rangeBands([0,i]),g=d3.scale.linear().domain(d3.extent(n,function(e){return e.edge_size})).clamp(!0),r=alamode.addContainerElement(r);d3.select(r).append("div").attr("class","mode-graphic-title").text(o),d3.select(r).append("div").attr("class","mode-network-matrix-order-picker").html('<p>Order: <select id="mode-network-matrix-order-picker-'+t+'"><option value="name">Name</option><option value="count">Frequency</option><option value="group">Group</option></select>'),d3.select(r).append("div").attr("class","mode-network-matrix").style("width",i).attr("id",t);var v=d3.tip().attr("class","mode-network-matrix-tooltip").offset([-10,0]).html(function(e){return e.z}),r=d3.select("#"+t).append("svg").attr("width",i+l+h).attr("height",d+m+e);r.call(v);var y=r.append("g").attr("transform","translate("+l+","+m+")");graph={nodes:p,links:n};var x=[],_=(p=graph.nodes).length;p.forEach(function(e,t){e.index=t,e.count=0,x[t]=d3.range(_).map(function(e){return{x:e,y:t,z:0}})}),graph.links.forEach(function(e){void 0!==x[e.source_id][e.target_id]?(x[e.source_id][e.target_id].z+=e.edge_size,p[e.source_id].count+=e.edge_size,p[e.target_id].count+=e.edge_size):(x[e.source_id][e.target_id]={},x[e.source_id][e.target_id].z=0)});var b,w={name:d3.range(_).sort(function(e,t){return d3.ascending(p[e].node,p[t].node)}),count:d3.range(_).sort(function(e,t){return p[t].count-p[e].count}),group:d3.range(_).sort(function(e,t){return d3.ascending(p[e].node_group,p[t].node_group)})};f.domain(w.name),r.append("text").attr("class","mode-network-matrix-axis-label").attr("x",(i+l+h)/2).attr("y",25).attr("text-anchor","middle").text(u),r.append("text").attr("class","mode-network-matrix-axis-label").attr("x",(d+m+e)/-2).attr("y",25).attr("transform","rotate(-90)").attr("text-anchor","middle").text(c),y.append("rect").attr("class","mode-network-matrix-background").attr("width",i).attr("height",d),(b=y.selectAll(".mode-network-matrix-row").data(x).enter().append("g").attr("class","mode-network-matrix-row").attr("transform",function(e,t){return"translate(0,"+f(t)+")"}).each(b)).append("line").attr("class","mode-network-matrix-line").attr("x2",i),b.append("text").attr("class","mode-network-matrix-row-text").attr("x",-6).attr("y",f.rangeBand()/2).attr("dy",".32em").attr("text-anchor","end").text(function(e,t){return p[t].node});d=y.selectAll(".mode-network-matrix-column").data(x).enter().append("g").attr("class","mode-network-matrix-column").attr("transform",function(e,t){return"translate("+f(t)+")rotate(-90)"});function b(e){d3.select(this).selectAll(".mode-network-matrix-cell").data(e.filter(function(e){return e.z})).enter().append("rect").attr("class","mode-network-matrix-cell").attr("x",function(e){return f(e.x)}).attr("width",f.rangeBand()).attr("height",f.rangeBand()).style("fill-opacity",function(e){return g(e.z)}).style("fill",function(e){return p[e.x].node_group==p[e.y].node_group?s[p[e.x].node_group]:"#2B2B2B"}).on("mouseover",function(e){var a;a=e,d3.selectAll(".mode-network-matrix-row-text").classed("active",function(e,t){return t==a.y}),d3.selectAll(".mode-network-matrix-column-text").classed("active",function(e,t){return t==a.x}),v.show(e)}).on("mouseout",function(e){d3.selectAll("text").classed("active",!1),v.hide(e)})}d.append("line").attr("class","mode-network-matrix-line").attr("x1",-i),d.append("text").attr("class","mode-network-matrix-column-text").attr("x",6).attr("y",f.rangeBand()/2).attr("dy",".32em").attr("text-anchor","start").text(function(e,t){return p[t].node}),d3.select("#mode-network-matrix-order-picker-"+t).on("change",function(){var e;e=this.value,f.domain(w[e]),(e=y.transition().duration(1e3)).selectAll(".mode-network-matrix-row").attr("transform",function(e,t){return"translate(0,"+f(t)+")"}).selectAll(".mode-network-matrix-cell").attr("x",function(e){return f(e.x)}),e.selectAll(".mode-network-matrix-column").attr("transform",function(e,t){return"translate("+f(t)+")rotate(-90)"})})},hive:function(e){d3.hive={},d3.hive.link=function(){function t(e,t){var a=r(o,this,e,t),e=r(l,this,e,t);a.a>e.a&&(n=e,e=a,a=n),e.a-a.a>Math.PI&&(a.a+=2*Math.PI);var t=a.a+(e.a-a.a)/3,n=e.a-(e.a-a.a)/3;return a.r0-a.r1||e.r0-e.r1?"M"+Math.cos(a.a)*a.r0+","+Math.sin(a.a)*a.r0+"L"+Math.cos(a.a)*a.r1+","+Math.sin(a.a)*a.r1+"C"+Math.cos(t)*a.r1+","+Math.sin(t)*a.r1+" "+Math.cos(n)*e.r1+","+Math.sin(n)*e.r1+" "+Math.cos(e.a)*e.r1+","+Math.sin(e.a)*e.r1+"L"+Math.cos(e.a)*e.r0+","+Math.sin(e.a)*e.r0+"C"+Math.cos(n)*e.r0+","+Math.sin(n)*e.r0+" "+Math.cos(t)*a.r0+","+Math.sin(t)*a.r0+" "+Math.cos(a.a)*a.r0+","+Math.sin(a.a)*a.r0:"M"+Math.cos(a.a)*a.r0+","+Math.sin(a.a)*a.r0+"C"+Math.cos(t)*a.r1+","+Math.sin(t)*a.r1+" "+Math.cos(n)*e.r1+","+Math.sin(n)*e.r1+" "+Math.cos(e.a)*e.r1+","+Math.sin(e.a)*e.r1}function r(e,t,a,n){var r=e.call(t,a,n),e=+("function"==typeof i?i.call(t,r,n):i)+c,a=+("function"==typeof d?d.call(t,r,n):d);return{r0:a,r1:d===s?a:+("function"==typeof s?s.call(t,r,n):s),a:e}}var o=function(e){return e.source},l=function(e){return e.target},i=function(e){return e.angle},d=function(e){return e.radius},s=d,c=-Math.PI/2;return t.source=function(e){return arguments.length?(o=e,t):o},t.target=function(e){return arguments.length?(l=e,t):l},t.angle=function(e){return arguments.length?(i=e,t):i},t.radius=function(e){return arguments.length?(d=s=e,t):d},t.startRadius=function(e){return arguments.length?(d=e,t):d},t.endRadius=function(e){return arguments.length?(s=e,t):s},t};var t=alamode.makeId(10),a=e.node_query,n=e.edge_query,r=e.groups_are_numeric,o=e.html_element||"body",l=e.title||queryName,i=e.chart_width||"800",d=e.chart_height||"800",s=e.group_colors||"",c=Math.min(i,d)/2-30,e=.2*c,a=alamode.getDataFromQuery(a),u=alamode.getDataFromQuery(n),m=_.uniq(_.map(a,"node_group")),h={};a.forEach(function(e){e.x=r?e.node_group:m.indexOf(e.node_group),e.y=e.node_size,h[e.node]=e}),u.forEach(function(e){e.source=h[e.source],e.target=h[e.target]});o=alamode.addContainerElement(o);d3.select(o).append("div").attr("class","mode-graphic-title").text(l),d3.select(o).append("div").attr("class","mode-network-matrix").style("width",i).attr("id",t),angle=r?d3.scale.linear().domain(d3.extent(a,function(e){return e.node_group})).range([0,2*Math.PI]):d3.scale.ordinal().domain(d3.range(m.length+1)).rangePoints([0,2*Math.PI]);var p=d3.scale.linear().domain(d3.extent(a,function(e){return e.node_size})).range([e,c]),f=d3.tip().attr("class","mode-hive-tooltip").offset([-10,0]).html(function(e){return e.node}),d=d3.select("#"+t).append("svg").attr("width",i).attr("height",d).append("g").attr("transform","translate("+i/2+","+d/2+")");function g(e){return e/Math.PI*180-90}d.call(f),d.selectAll(".mode-hive-axis").data(d3.range(m.length)).enter().append("line").attr("class","mode-hive-axis").attr("transform",function(e){return"rotate("+g(angle(e))+")"}).attr("x1",p.range()[0]).attr("x2",p.range()[1]),d.selectAll(".mode-hive-link").data(u).enter().append("path").attr("class","mode-hive-link").attr("d",d3.hive.link().angle(function(e){return angle(e.x)}).radius(function(e){return p(e.y)})).style("stroke",function(e){return s[e.source.node_group]}),d.selectAll(".mode-hive-node").data(a).enter().append("circle").attr("class","mode-hive-node").attr("transform",function(e){return"rotate("+g(angle(e.x))+")"}).attr("cx",function(e){return p(e.y)}).attr("r",5).style("fill",function(e){return s[e.node_group]}).on("mouseover",function(t){f.show(t),d3.select(this).attr("class","mode-hive-node mode-hive-node-selected"),d3.selectAll(".mode-hive-link").data(u).attr("class",function(e){return e.source.node==t.node||e.target.node==t.node?"mode-hive-link-selected":"mode-hive-link"})}).on("mouseout",function(e){f.hide(e),d3.select(this).attr("class","mode-hive-node"),d3.selectAll(".mode-hive-link-selected").attr("class","mode-hive-link")})},conditionalFormattingByColumn:function(a){var g="#"+a.table_id,e=a.query_name,t=a.column_rules,v=alamode.getDataFromQuery(e),y=(alamode.getColumnsFromQuery(e),{});function n(e){var t,a=$(g+" table"),n=$(g+" .js-header-table"),n=n?$(g+" .js-col-header"):$(n).find("th");a.find("tr");n.each(function(){text=$(this).find(".axel-table-header-label").text(),t=$(this).attr("data-axel-column"),y[text]=t}),e.forEach(function(f){f.rules.forEach(function(e){var a,n,r,o,l,i,d,s,t,c,u,m,h,p=e.shade_text||!1;"gradient"==e.type?(s=f.column,t=e.color,c=p,u=d3.extent(_.map(v,s)),m=d3.scale.linear().domain(u).interpolate(d3.interpolateHsl).range(t),h=y[s],v.forEach(function(e,t){var a=g+" table [data-axel-rowkey='"+t+"'][data-axel-column='"+h+"']",t=m(e[s]),e=x(t),a=$(a);c?a.css("color",t):a.css({background:t,color:e})})):"above"!=e.type&&"below"!=e.type&&"equal"!=e.type||(a=f.column,n=e.type,r=e.value,o=e.color,l=p,i=y[a],d=x(o),v.forEach(function(e,t){t=$(g+" table [data-axel-rowkey='"+t+"'][data-axel-column='"+i+"']");("above"==n&&e[a]>=r||"below"==n&&e[a]<=r||"equal"==n&&e[a]==r)&&(l?t.css("color",o):t.css({background:o,color:d}))}))})})}function x(e){var t=/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(e);return 125<(a=t?(rgb=(e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e=e))?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null,Math.round((299*parseInt(rgb.r)+587*parseInt(rgb.g)+114*parseInt(rgb.b))/1e3)):255)?"#2B2B2B":"#FCFCFC"}setTimeout(function(){n(t)},1e3),$(g).mousemove(function(){n(t)})},customizeTable:function(e){window.dispatchAction({type:"Embed.AlamodeCustomizeTable",payload:e})},conditionalFormattingByTable:function(a){var u="#"+a.table_id,e=a.query_name,m=a.columns;rules=a.rules;var h=alamode.getDataFromQuery(e),p=(alamode.getColumnsFromQuery(e),{}),t=[];m.forEach(function(e){e=d3.extent(_.map(h,e));t=t.concat(e)});var f=d3.extent(t);function n(e){var t,a=$(u+" table"),n=$(u+" .js-header-table"),n=n?$(u+" .js-col-header"):$(n).find("th");a.find("tr");n.each(function(){text=$(this).find(".axel-table-header-label").text(),t=$(this).attr("data-axel-column"),p[text]=t}),e.forEach(function(e){var r,o,l,i,d,t,s,c,a=e.shade_text||!1;"gradient"==e.type?(t=e.color,s=a,c=d3.scale.linear().domain(f).interpolate(d3.interpolateHsl).range(t),h.forEach(function(n,r){m.forEach(function(e){var t=p[e],a=u+" table [data-axel-rowkey='"+r+"'][data-axel-column='"+t+"']",t=c(n[e]),e=g(t),a=$(a);s?a.css("color",t):a.css({background:t,color:e})})})):"above"!=e.type&&"below"!=e.type&&"equal"!=e.type||(r=e.type,o=e.value,l=e.color,i=a,d=g(l),h.forEach(function(a,n){m.forEach(function(e){var t=p[e],t=$(u+" table [data-axel-rowkey='"+n+"'][data-axel-column='"+t+"']");("above"==r&&a[e]>=o||"below"==r&&a[e]<=o||"equal"==r&&a[e]==o)&&(i?t.css("color",l):t.css({background:l,color:d}))})}))})}function g(e){var t=/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(e);return 125<(a=t?(rgb=(e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e=e))?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null,Math.round((299*parseInt(rgb.r)+587*parseInt(rgb.g)+114*parseInt(rgb.b))/1e3)):255)?"#2B2B2B":"#FCFCFC"}setTimeout(function(){n(rules)},1e3),$(u).mousemove(function(){n(rules)})},addTableOfContents:function(e){var t=(e=void 0===e?"default":e).text_color,a=e.background_color,n=e.hover_color;$(".mode-header").addClass("has-nav");var r=$("<nav class='fixed-nav-bar'></nav>");$(".row").each(function(){$(this).children().each(function(){var e=$(this).find("mode-chart").attr("id")||$(this).find("mode-table").attr("id")||$(this).find("mode-python").attr("id");if(!e)return!0;e.includes("chart")||e.includes("table")?(t=document.getElementById(e),t=(0<$(t).find("mode-pivot-table").length?document.getElementById(e).getElementsByClassName("in-place-edit-text"):document.getElementById(e).getElementsByClassName("chart-title"))[0].innerText):e.includes("python")&&(t=document.getElementById(e).getElementsByClassName("in-place-edit-text")[0].innerText);var t=$("<a class='scroll-link' href=#"+e+">"+(t.includes("Click to add title")?"Untitled":t)+"</a>");r.append(t)})});var o=$("<div class='mode-grid container''></div>");$(".mode-content").prepend(o);e=$("<div class='row'></div>");o.prepend(e);o=$("<div class='col-md-12'></div>");e.prepend(o),o.prepend(r),t&&$(".fixed-nav-bar a").css("color",t),a&&$(".fixed-nav-bar").css("background-color",a),n&&$(".fixed-nav-bar a").hover(function(){$(this).css("color",n)},function(){t?$(this).css("color",t):$(this).css("color","")}),setTimeout(function(){$(".scroll-link").on("click",function(e){e.preventDefault();var t=$(this).attr("href");e=t,t=750,e=$(e).offset().top-50,$("html,body").animate({scrollTop:e},t)})},100)},xAnnotations:function(e){var a=e.chart_id,r=e.comment_values,o=e.comments,l=e.color||[],d=e.is_date||!1;setTimeout(function(){var t=$("#"+a).find("div.highcharts-container")[0].id,e=Highcharts.charts;if(chart=e.filter(function(e){if(e)return e.container.id==t})[0],data=chart.series[0].data,d)for(i=0;i<r.length;i++)r[i]=new Date(r[i]).getTime();var n=data.filter(function(e){if(e)return 0<=r.indexOf(e.category)});chart.update({chart:{events:{load:function(e){for(i=0;i<n.length;i++){var t=n[i],a=l[i]||t.color||"#FCFCFC";e.renderer.label(o[i],t.plotX+e.plotLeft,10,"callout",t.plotX+e.plotLeft,t.plotY+e.plotTop).attr({fill:"#FCFCFC",stroke:a,"stroke-width":1,radius:10,zIndex:4}).add()}}(chart)}}})},250)},barChartFunnel:function(e){var n=e.chart_id;setTimeout(function(){var t=$("#"+n).find("div.highcharts-container")[0].id,e=Highcharts.charts;chart=e.filter(function(e){if(e)return e.container.id==t})[0],data=chart.series[0].data;var a=d3.format(".1%"),e=chart.series[1].color;chart.update({series:[{color:e,opacity:.6},{dataLabels:{enabled:!0,useHTML:!0,borderRadius:5,padding:20,formatter:function(){return 0==this.point.index?null:a(this.percentage/100)},border:"black",shape:"square",backgroundColor:"rgba(0, 0, 0, 0.75)",style:{fontSize:"11px",color:"#FFFFFF",fontWeight:100,textOutline:"none"}}}],plotOptions:{series:{dataLabels:{x:-210,y:150}}}});e=a(chart.yAxis[0].dataMin/chart.yAxis[0].dataMax);chart.renderer.text("Overall Rate<br/><br/>"+e,chart.plotSizeX-20,chart.plotTop+20).attr({zIndex:5}).css({fontSize:"14px",color:"#FFFFFF"}).add(),chart.renderer.rect(chart.plotSizeX-30,chart.plotTop,124,50,2).attr({"stroke-width":2,stroke:"black",fill:"black",zIndex:4}).add()},250)},highChartsSeriesColor:function(e){var a=e.series_Colors;var n=[];n.push(function(){}),H=Highcharts,H.Chart.prototype.callbacks.push(function(e){for(var t=0;t<n.length;++t)n[t].call(this,event);e.update({series:function(t,a){let n=new Array(t.length);for(var r=0;r<n.length;r++){let e=a.filter(function(e){return e.seriesName===t[r].name});null==e[0]&&(console.log("Jon Color"),e[0]=""),console.log(e[0].color),n[r]={color:e[0].color}}return n}(this.series,a)})})}};